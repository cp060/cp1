pipeline {
    agent any
    
    stages {
        stage('Get Code'){
            steps {
                // get code from repo
                bat 'git clone --branch feature_fix_racecond https://github.com/cp060/cp1.git'
            }
        }
    
        stage('Build') {
            steps {
                echo 'Eip, this is Python mai fren, nothing to comppile!!'
                echo WORKSPACE
                bat 'dir'
            }
        }
        
        stage('Unit') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {        
                    bat '''
                        SET PYTHONPATH=%WORKSPACE%\\cp1
                        pytest --junitxml=result-unit.xml cp1\\test\\unit
                    '''
                }
            }
        }
                
        stage('Rest'){
            steps {
                bat '''
                    set FLASK_APP=cp1\\app\\api.py
                    set FLASK_ENV=development
                    start flask run                        
                    start java -jar C:\\Users\\toma\\Documents\\unir\\wiremock-standalone-3.3.1.jar --port 9090 --root-dir C:\\Users\\toma\\Documents\\unir\\wiremock
                    SET PYTHONPATH=%WORKSPACE%\\cp1
                    powershell C:\\Users\\toma\\val.ps1
                    pytest --junitxml=result-rest.xml cp1\\test\\rest
                '''
            }
        }
        
        stage('Results') {
            steps{
                junit 'result*.xml'
            }
        }
        
    }
}
